###############################################################################
# Dreamwidth iptables rules
# Note: this must be changed whenever a new host is added
# Initially copied from Mark's notes.
###############################################################################

*filter

# Allows all loopback (lo0) traffic and drop all 
# traffic to 127/8 that doesn't use lo0
-A INPUT -i lo -j ACCEPT
-A INPUT -i ! lo -d 127.0.0.0/8 -j REJECT

# Accept inbound private traffic from one of our servers
-A INPUT -s 10.176.64.124 -j ACCEPT
-A INPUT -s 10.176.64.125 -j ACCEPT
-A INPUT -s 10.176.64.126 -j ACCEPT
-A INPUT -s 10.176.64.127 -j ACCEPT
-A INPUT -s 10.176.64.128 -j ACCEPT
-A INPUT -s 10.176.64.129 -j ACCEPT
-A INPUT -s 10.176.64.130 -j ACCEPT
-A INPUT -s 10.176.64.131 -j ACCEPT
-A INPUT -s 10.176.64.132 -j ACCEPT
-A INPUT -s 10.176.64.133 -j ACCEPT
-A INPUT -s 10.176.64.134 -j ACCEPT
-A INPUT -s 10.176.64.135 -j ACCEPT
-A INPUT -s 10.176.64.137 -j ACCEPT
-A INPUT -s 10.176.68.212 -j ACCEPT
-A INPUT -s 10.176.68.231 -j ACCEPT
-A INPUT -s 10.176.71.86 -j ACCEPT
-A INPUT -s 10.176.71.88 -j ACCEPT
-A INPUT -s 10.176.71.89 -j ACCEPT
-A INPUT -s 10.176.71.90 -j ACCEPT
-A INPUT -s 10.176.73.113 -j ACCEPT
-A INPUT -s 10.176.74.51 -j ACCEPT
-A INPUT -s 10.176.74.52 -j ACCEPT
-A INPUT -s 10.176.74.53 -j ACCEPT
-A INPUT -s 10.176.74.54 -j ACCEPT
-A INPUT -s 10.176.74.55 -j ACCEPT
-A INPUT -s 10.176.74.56 -j ACCEPT
-A INPUT -s 10.176.74.58 -j ACCEPT
-A INPUT -s 10.176.74.59 -j ACCEPT
-A INPUT -s 10.176.74.60 -j ACCEPT
-A INPUT -s 10.176.74.61 -j ACCEPT
-A INPUT -s 10.176.74.62 -j ACCEPT
-A INPUT -s 10.176.74.63 -j ACCEPT
-A INPUT -s 10.176.74.64 -j ACCEPT
-A INPUT -s 10.176.74.65 -j ACCEPT
-A INPUT -s 10.176.74.66 -j ACCEPT
-A INPUT -s 10.176.74.67 -j ACCEPT
-A INPUT -s 10.176.74.68 -j ACCEPT
-A INPUT -s 10.176.74.69 -j ACCEPT
-A INPUT -s 10.176.74.70 -j ACCEPT
-A INPUT -s 10.176.74.71 -j ACCEPT
-A INPUT -s 10.176.74.72 -j ACCEPT
-A INPUT -s 10.176.74.73 -j ACCEPT
-A INPUT -s 10.176.74.74 -j ACCEPT
-A INPUT -s 10.176.74.75 -j ACCEPT
-A INPUT -s 10.176.74.76 -j ACCEPT
-A INPUT -s 10.176.74.77 -j ACCEPT
-A INPUT -s 10.176.74.78 -j ACCEPT
-A INPUT -s 10.176.74.79 -j ACCEPT
-A INPUT -s 10.176.74.80 -j ACCEPT

<% if has_variable?("allowed_ports") && !allowed_ports.empty? -%>
# Discards all traffic to/from netblocks on Spamhaus drop list
# ( see http://www.spamhaus.org/drop/ )
<% droplist = scope.function_template('iptables/spamhaus-drop.erb');
   droplist.each do |dropnet| -%>
-A INPUT -s <%= dropnet.chomp %> -j DROP
-A OUTPUT -d <%= dropnet.chomp %> -j DROP
<% end -%>

<% end -%>
# Accepts all established inbound connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allows all outbound traffic
-A OUTPUT -j ACCEPT

<% if has_variable?("allowed_ports") && !allowed_ports.empty? -%>
# Allow inbound traffic on certain public ports
<% allowed_ports.each do |val| -%>
-A INPUT --proto tcp --dport <%= val %> -j ACCEPT
<% end -%>

<% end -%>
# Reject all other inbound - default deny unless explicitly allowed policy
-A INPUT -j REJECT
-A FORWARD -j REJECT

COMMIT
